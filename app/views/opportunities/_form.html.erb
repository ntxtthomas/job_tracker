<div data-controller="role-type">
<%= form_with(model: opportunity) do |form| %>
<% if opportunity.errors.any? %>
<div style="color: red">
  <h2><%= pluralize(opportunity.errors.count, "error") %> prohibited this opportunity from being saved:</h2>

  <ul>
    <% opportunity.errors.each do |error| %>
    <li><%= error.full_message %></li>
    <% end %>
  </ul>
</div>
<% end %>

<div>
  <%= form.label :role_type, "Role Type", style: "display: block" %>
  <%= form.select :role_type, 
      options_for_select(
        Opportunity::ROLE_TYPES.map { |k, v| [v, k] }, 
        opportunity.role_type || "software_engineer"
      ), 
      { prompt: "Select role type" }, 
      { style: "display: block; width: 250px; height: 30px;", 
        data: { 
          role_type_target: "select",
          action: "change->role-type#toggle" 
        } } %>
</div>

<div>
  <%= form.label :company_id, "Company", style: "display: block" %>
  <%= form.select :company_id, 
      options_from_collection_for_select(
        defined?(@companies) ? @companies : Company.all.order(:name), 
        :id, 
        :name, 
        opportunity.company_id
      ), 
      { prompt: "Select a company" }, 
      { style: "display: block; width: 250px; height: 30px;" } %>
</div>

<div>
  <%= form.label :position_title, style: "display: block" %>
  <%= form.text_field :position_title, style: "width: 250px; height: 25px;" %>
</div>

<div>
  <%= form.label :application_date, style: "display: block" %>
  <%= form.date_field :application_date, style: "width: 250px; height: 25px;" %>
</div>

<div>
  <%= form.label :status, style: "display: block" %>
  <%= form.select :status, 
      options_for_select([
        ["Applied", "submitted"],
        ["Under Review", "under_review"],
        ["Phone Screen", "phone_screen"],
        ["Interview Scheduled", "interview"],
        ["Responded", "responded"],
        ["Offer Received", "offer"],
        ["Closed", "closed"],
        ["Withdrawn", "withdrawn"]
      ], opportunity.status), 
      { include_blank: "Select status" }, 
      { style: "display: block; width: 250px; height: 30px;" } %>
</div>

<div>
  <%= form.label :remote, style: "display: block" %>
  <%= form.check_box :remote, { checked: opportunity.remote.nil? ? true : opportunity.remote }, "true", "false" %>
</div>

<!-- Role-specific metadata fields -->
<div id="role-specific-fields">
  <!-- Software Engineer Fields -->
  <div data-role-type-target="section" data-role="software_engineer" style="<%= opportunity.role_type == 'software_engineer' || opportunity.role_type.blank? ? '' : 'display: none;' %>">
    <%= form.label "Technologies" %>
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: var(--bg-primary, #fff);">
      <% Technology::CATEGORIES.each do |category| %>
        <% techs = Technology.where(category: category).order(:name) %>
        <% next if techs.empty? %>
        
        <fieldset style="margin-bottom: 15px; border: none; padding: 0;">
          <legend style="font-weight: bold; color: var(--text-primary, #333); margin-bottom: 5px;"><%= category %></legend>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 5px;">
            <% techs.each do |tech| %>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <%= check_box_tag "opportunity[technology_ids][]", tech.id, opportunity.technologies.include?(tech), id: "opportunity_technology_ids_#{tech.id}" %>
                <span style="margin-left: 5px; font-size: 14px;"><%= tech.name %></span>
              </label>
            <% end %>
          </div>
        </fieldset>
      <% end %>
    </div>
    <%= hidden_field_tag "opportunity[technology_ids][]", "" %>
  
    <%= form.label :other_tech_stack, "Other Technologies (not listed above)", style: "display: block; margin-top: 10px;" %>
    <%= form.text_area :other_tech_stack, rows: 2, placeholder: "e.g., Custom framework, proprietary tools...", style: "display: block; width: 100%;" %>
  </div>

  <!-- Sales Engineer Fields -->
  <div data-role-type-target="section" data-role="sales_engineer" style="<%= opportunity.role_type == 'sales_engineer' ? '' : 'display: none;' %>">
    <%= render "sales_engineer_fields", opportunity: opportunity %>
  </div>

  <!-- Solutions Engineer Fields -->
  <div data-role-type-target="section" data-role="solutions_engineer" style="<%= opportunity.role_type == 'solutions_engineer' ? '' : 'display: none;' %>">
    <%= render "solutions_engineer_fields", opportunity: opportunity %>
  </div>

  <!-- Product Manager Fields -->
  <div data-role-type-target="section" data-role="product_manager" style="<%= opportunity.role_type == 'product_manager' ? '' : 'display: none;' %>">
    <%= render "product_manager_fields", opportunity: opportunity %>
  </div>
</div>

<div>
  <%= form.label :source, style: "display: block" %>
  <%= form.select :source, 
      options_for_select([
        ["LinkedIn", "linkedin"],
        ["JobrightAI", "jobrightai"],
        ["Y Combinator", "y_combinator"],
        ["Indeed", "indeed"],
        ["Company Website", "company_website"],
        ["Glassdoor", "glassdoor"],
        ["AngelList", "angellist"],
        ["Dice", "dice"],
        ["Monster", "monster"],
        ["ZipRecruiter", "ziprecruiter"],
        ["Referral", "referral"],
        ["Recruiter", "recruiter"],
        ["Job Fair", "job_fair"],
        ["Other", "other"]
      ], opportunity.source), 
      { prompt: "Select source" }, 
      { style: "display: block; width: 250px; height: 30px;" } %>
</div>

<div>
  <%= form.label :notes, style: "display: block" %>
  <%= form.text_area :notes, rows: 4, style: "display: block; width: 100%;" %>
</div>

<div>
  <%= form.label :salary_range, style: "display: block" %>
  <%= form.text_field :salary_range, style: "width: 250px; height: 25px;" %>
</div>

<div>
  <%= form.label :listing_url, "Listing URL", style: "display: block" %>
  <%= form.url_field :listing_url, placeholder: "https://...", style: "width: 250px; height: 25px;" %>
</div>

<div>
  <%= form.label :chatgpt_match, "ChatGPT Match", style: "display: block" %>
  <%= form.text_field :chatgpt_match, placeholder: "e.g., 85%", style: "height: 25px;" %>
</div>

<div>
  <%= form.label :jobright_match, "Jobright Match", style: "display: block" %>
  <%= form.text_field :jobright_match, placeholder: "e.g., 90%", style: "height: 25px;" %>
</div>

<div>
  <%= form.label :linkedin_match, "LinkedIn Match", style: "display: block" %>
  <%= form.select :linkedin_match, 
      options_for_select([
        ["Low", "low"],
        ["Medium", "medium"],
        ["Top", "top"]
      ], opportunity.linkedin_match), 
      { prompt: "Select" }, 
      { style: "display: block; width: 145px; height: 25px;" } %>
</div>

<div>
  <%= form.submit style: "margin-top: 20px; background-color: #0d6efd; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; transition: all 0.2s ease;", onmouseover: "this.style.backgroundColor='#0b5ed7'", onmouseout: "this.style.backgroundColor='#0d6efd'", onmousedown: "this.style.transform='scale(0.95)'", onmouseup: "this.style.transform='scale(1)'" %>
</div>
<% end %>
</div>
